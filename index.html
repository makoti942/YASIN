<!doctype html>
<html lang="en" dir="auto">
    <head>
        <meta charset="UTF-8" />
        <link rel="icon" type="image/png" href="/makoti-logo.png?v=1.2" />
        <link rel="apple-touch-icon" href="/makoti-logo.png?v=1.2" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
        <title>MAKOTI TRADERS</title>
        <link rel="manifest" href="/manifest.json" />

        <style>
            :root {
                font-size: 62.5%;
            }

            /* 1. WELCOME SCREEN (SPLASH) STYLING */
            #welcome-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #000000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 100000; /* Highest priority */
                transition:
                    opacity 0.8s ease,
                    visibility 0.8s;
            }

            #welcome-screen.fade-out {
                opacity: 0;
                visibility: hidden;
            }

            .welcome-logo {
                width: 130px;
                height: auto;
                margin-bottom: 25px;
                animation: pulseLogo 2s infinite ease-in-out;
            }

            .welcome-text {
                color: #00d9ff;
                font-family: Arial, sans-serif;
                font-size: 2.6rem;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 4px;
                margin-bottom: 35px;
            }

            /* Loading Circle */
            .loader {
                width: 50px;
                height: 50px;
                border: 3px solid #1a1a1a;
                border-radius: 50%;
                display: inline-block;
                position: relative;
                animation: rotation 1s linear infinite;
            }
            .loader::after {
                content: '';
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 42px;
                height: 42px;
                border-radius: 50%;
                border: 3px solid transparent;
                border-bottom-color: #00d9ff;
            }

            @keyframes rotation {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            @keyframes pulseLogo {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.08);
                }
            }

            /* 2. MAIN SITE THEME */
            .blocklyMainBackground,
            .injectionDiv,
            .body.theme--light {
                background-color: #000000 !important;
                fill: #000000 !important;
            }

            /* LABEL COLOR FIX */
            .blocklyText {
                fill: #000000 !important;
            }

            /* SURGICAL COLORS */
            .makoti-loss,
            .loss {
                fill: #ff444f !important;
                color: #ff444f !important;
            }
            .makoti-profit,
            .profit {
                fill: #00ff41 !important;
                color: #00ff41 !important;
            }

            .makoti-stop-btn {
                background-color: #ff444f !important;
                box-shadow: 0 0 15px #ff444f !important;
                color: white !important;
            }

            .blocklyEditableText > .blocklyFieldRect {
                fill: #1a1a1a !important;
                stroke: #00d9ff !important;
            }
        </style>
    </head>

    <body class="body theme theme--light">
        <div id="welcome-screen">
            <img src="/makoti-logo.png?v=1.2" alt="Logo" class="welcome-logo" />
            <div class="welcome-text">Makoti Traders</div>
            <span class="loader"></span>
        </div>

        <div id="root"></div>

        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').then(
                        registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        },
                        err => {
                            console.log('ServiceWorker registration failed: ', err);
                        }
                    );
                });
            }

            let deferredPrompt;
            const installButton = document.createElement('button');
            installButton.style.position = 'fixed';
            installButton.style.bottom = '1rem';
            installButton.style.right = '1rem';
            installButton.style.padding = '1rem 2rem';
            installButton.style.backgroundColor = '#00d9ff';
            installButton.style.color = 'black';
            installButton.style.border = 'none';
            installButton.style.borderRadius = '5px';
            installButton.style.cursor = 'pointer';
            installButton.textContent = 'Install App';
            installButton.style.display = 'none';
            document.body.appendChild(installButton);

            window.addEventListener('beforeinstallprompt', e => {
                e.preventDefault();
                deferredPrompt = e;
                installButton.style.display = 'block';

                installButton.addEventListener('click', () => {
                    installButton.style.display = 'none';
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(choiceResult => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                        } else {
                            console.log('User dismissed the A2HS prompt');
                        }
                        deferredPrompt = null;
                    });
                });
            });
            // Handle Welcome Screen removal
            window.addEventListener('load', () => {
                const splash = document.getElementById('welcome-screen');
                setTimeout(() => {
                    splash.classList.add('fade-out');
                }, 2500); // Shows for 2.5 seconds
            });

            const makotiEngine = new MutationObserver(() => {
                // Button coloring
                document.querySelectorAll('button').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes('stop')) {
                        btn.classList.add('makoti-stop-btn');
                    }
                });

                // Text coloring logic
                const allNumbers = document.querySelectorAll('.blocklyText, .dc-stat__value, span, div');
                allNumbers.forEach(el => {
                    const val = el.textContent.trim();
                    if (val.includes('-')) {
                        el.style.setProperty('fill', '#ff444f', 'important');
                        el.style.setProperty('color', '#ff444f', 'important');
                    } else if ((val.includes('$') || val.includes('+')) && !val.includes(':')) {
                        el.style.setProperty('fill', '#00ff41', 'important');
                        el.style.setProperty('color', '#00ff41', 'important');
                    } else if (el.classList.contains('blocklyText') && !el.closest('.blocklyEditableText')) {
                        el.style.setProperty('fill', '#000000', 'important');
                    }
                });
            });

            makotiEngine.observe(document.body, { childList: true, subtree: true, characterData: true });
        </script>
    </body>
</html>
